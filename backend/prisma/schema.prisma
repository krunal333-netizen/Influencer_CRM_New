// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== User Management =====

model User {
  id                 String     @id @default(cuid())
  email              String     @unique
  name               String
  password           String
  hashedRefreshToken String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  
  roles     Role[]
  firm      Firm?      @relation(fields: [firmId], references: [id])
  firmId    String?
  
  @@index([firmId])
  @@map("users")
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  users       User[]
  permissions Permission[]
  
  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  roles       Role[]
  
  @@map("permissions")
}

// ===== Organization & Stores =====

model Firm {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users     User[]
  stores    Store[]
  
  @@map("firms")
}

model Store {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  firm      Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  firmId    String
  
  campaigns Campaign[]
  sentShipments CourierShipment[] @relation("SendStore")
  returnedShipments CourierShipment[] @relation("ReturnStore")
  
  @@index([firmId])
  @@map("stores")
}

// ===== Products =====

enum ProductCategory {
  ELECTRONICS
  FASHION
  BEAUTY
  LIFESTYLE
  FITNESS
  HOME
  FOOD
  OTHER
}

model Product {
  id          String          @id @default(cuid())
  name        String
  sku         String          @unique
  asCode      String?         @unique // Alternative unique code for products
  description String?
  category    ProductCategory @default(OTHER)
  stock       Int             @default(0)
  price       Decimal         @db.Decimal(10, 2)
  imageUrls   Json?           // Array of image URLs
  metadata    Json?           // Additional product metadata
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  campaignProducts CampaignProduct[]
  invoiceImages      InvoiceImage[]
  
  @@map("products")
}

// ===== Influencers =====

enum InfluencerStatus {
  COLD
  ACTIVE
  FINAL
}

model Influencer {
  id        String            @id @default(cuid())
  name      String
  email     String            @unique
  phone     String?
  bio       String?
  followers Int?              @default(0)
  status    InfluencerStatus  @default(COLD)
  platform  String?           // e.g., Instagram, TikTok, YouTube
  profileUrl String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  
  campaignLinks InfluencerCampaignLink[]
  courierShipments CourierShipment[]
  
  @@index([status])
  @@map("influencers")
}

// ===== Enums =====

enum CampaignType {
  REELS
  POSTS
  STORIES
  MIXED
}

enum CourierStatus {
  PENDING
  SENT
  IN_TRANSIT
  DELIVERED
  RETURNED
  FAILED
}

enum InvoiceImageStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

// ===== Campaigns =====

model Campaign {
  id               String       @id @default(cuid())
  name             String
  description      String?
  status           String       @default("DRAFT") // DRAFT, ACTIVE, COMPLETED, CANCELLED
  type             CampaignType @default(MIXED)
  budget           Decimal?     @db.Decimal(12, 2)
  budgetSpent      Decimal?     @db.Decimal(12, 2) @default(0)
  budgetAllocated  Decimal?     @db.Decimal(12, 2)
  startDate        DateTime?
  endDate          DateTime?
  deliverableDeadline DateTime?
  brief           String?       // Campaign brief/requirements
  reelsRequired    Int?         @default(0)
  postsRequired    Int?         @default(0)
  storiesRequired  Int?         @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  store            Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId          String
  
  products           CampaignProduct[]
  influencerLinks    InfluencerCampaignLink[]
  financialDocuments FinancialDocument[]
  invoiceImages      InvoiceImage[]
  courierShipments   CourierShipment[]
  
  @@index([storeId])
  @@index([status])
  @@index([type])
  @@map("campaigns")
}

model CampaignProduct {
  id        String   @id @default(cuid())
  quantity  Int
  plannedQty Int?    // Planned quantity for future reference
  discount  Decimal? @db.Decimal(5, 2)
  notes     String?  // Additional notes for campaign-product relationship
  dueDate   DateTime? // Due date for product delivery
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId  String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   String
  
  @@unique([campaignId, productId])
  @@index([campaignId])
  @@index([productId])
  @@map("campaign_products")
}

// ===== Influencer-Campaign Links =====

model InfluencerCampaignLink {
  id              String   @id @default(cuid())
  rate            Decimal  @db.Decimal(10, 2)
  status          String   @default("PENDING") // PENDING, ACCEPTED, REJECTED, COMPLETED
  deliverables    String?
  deliverableType String?  // e.g., "reel", "post", "story"
  expectedDate    DateTime? // Expected delivery date for deliverables
  notes          String?   // Additional notes for the collaboration
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  influencer      Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  influencerId    String
  campaign        Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId      String
  
  @@unique([influencerId, campaignId])
  @@index([influencerId])
  @@index([campaignId])
  @@index([status])
  @@map("influencer_campaign_links")
}

// ===== Financial Documents =====

enum FinancialDocumentType {
  PO           // Purchase Order
  INVOICE
  FORM
}

model FinancialDocument {
  id            String                  @id @default(cuid())
  type          FinancialDocumentType
  documentNumber String                 @unique
  amount        Decimal                 @db.Decimal(12, 2)
  status        String                  @default("PENDING") // PENDING, APPROVED, PAID, REJECTED
  issueDate     DateTime
  dueDate       DateTime?
  paidDate      DateTime?
  description   String?
  metadata      Json?                   // Additional metadata as JSON
  filePath      String?                 // Path to stored document
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  
  campaign      Campaign                @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId    String
  
  @@index([campaignId])
  @@index([type])
  @@index([status])
  @@map("financial_documents")
}

// ===== Invoice Images =====

model InvoiceImage {
  id            String             @id @default(cuid())
  imagePath     String             // Path to stored invoice image
  ocrData       Json?              // OCR extracted text/data
  extractedTotal Decimal?          @db.Decimal(10, 2) // Total amount extracted from OCR
  status        InvoiceImageStatus @default(PENDING)
  campaign      Campaign?          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId    String?
  product       Product?           @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId     String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  
  @@index([campaignId])
  @@index([productId])
  @@index([status])
  @@map("invoice_images")
}

// ===== Courier Shipments =====

model CourierShipment {
  id            String        @id @default(cuid())
  trackingNumber String       @unique
  courierName   String        // e.g., UPS, FedEx, DHL
  courierCompany String       // Full company name
  sendStore     Store?        @relation("SendStore", fields: [sendStoreId], references: [id], onDelete: SetNull)
  sendStoreId   String?
  returnStore   Store?        @relation("ReturnStore", fields: [returnStoreId], references: [id], onDelete: SetNull)
  returnStoreId String?
  influencer    Influencer?   @relation(fields: [influencerId], references: [id], onDelete: SetNull)
  influencerId  String?
  campaign      Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignId    String?
  sentDate      DateTime?
  receivedDate  DateTime?
  returnedDate  DateTime?
  status        CourierStatus @default(PENDING)
  statusTimeline Json?        // JSON object tracking status changes over time
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([campaignId])
  @@index([influencerId])
  @@index([sendStoreId])
  @@index([returnStoreId])
  @@index([status])
  @@map("courier_shipments")
}

// ===== Apify Integration =====

model ApifyRunLog {
  id            String   @id @default(cuid())
  runId         String   @unique
  taskId        String?
  status        String   // CREATED, READY, RUNNING, SUCCEEDED, FAILED, TIMED_OUT, ABORTED
  startedAt     DateTime?
  finishedAt    DateTime?
  statusMessage String?
  resultsCount  Int      @default(0)
  metadata      Json?    // Additional run data
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([taskId])
  @@index([status])
  @@map("apify_run_logs")
}

// ===== Analytics =====

model AnalyticsSnapshot {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now())
  
  // Campaign metrics
  totalCampaigns    Int      @default(0)
  activeCampaigns   Int      @default(0)
  totalBudget       Decimal? @db.Decimal(15, 2)
  
  // Influencer metrics
  totalInfluencers  Int      @default(0)
  coldInfluencers   Int      @default(0)
  activeInfluencers Int      @default(0)
  finalInfluencers  Int      @default(0)
  
  // Financial metrics
  totalRevenue      Decimal? @db.Decimal(15, 2)
  totalExpenses     Decimal? @db.Decimal(15, 2)
  
  // Additional metadata
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([timestamp])
  @@map("analytics_snapshots")
}
